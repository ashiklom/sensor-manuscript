#' ---
#' title: Validation based on measured EWT and LMA
#' author: Alexey Shiklomanov
#' output_format: html_document
#' ---

#' # Introduction
#' In addition to validating based on the spectra, we also validate our 
#' PROSPECT inversion by comparing inversion estimates of EWT (Cw) and LMA (Cm) 
#' to direct measurements of these two traits. This is the script used to 
#' perform this validation. First, it generates a one-to-one figure for EWT and 
#' LMA. Second, it generates a table of error statistics (see manuscript for 
#' more details).

#' # Setup
#' First, we load package dependencies. PEcAnRTM is used for parameter name 
#' shortcuts as well as the implicitly loaded `data.table` package. `ggplot2`, 
#' `gridExtra`, and `grid` are used for generating the figure.

library(PEcAnRTM)
library(ggplot2)
library(gridExtra)
library(grid)

#' The data used for this script is the `fft.f` data table (see `load.fft.R` 
#' and `preprocess.fft.R` for details). Here, we subset this data to include 
#' only results from field spectra where parameter estimates are not `NA` and 
#' exclude shrub, grass, and unknown species. To facilitate interpretation of 
#' the plot by ecologists, we convert both the inversion estimates and direct 
#' measurements of LMA to the more common g m-2 units. For convenience, we also 
#' create subset data tables for just hardwood (`fft.h`) and conifer (`fft.c`) 
#' species.

load("data/FFT.processed.RData")
fft.f <- fft.f[sensor=="identity"][!is.na(N.mu)][plant.type %in% c("hardwood", "conifer")]
fft.f <- fft.f[, Cm.mu.gm2 := Cm.mu * 100^2][, LMA_gm2 := LMA_g_DW_cm2 * 100^2]
fft.h <- fft.f[plant.type == "hardwood"]
fft.c <- fft.f[plant.type == "conifer"]

#' # Preparing the plot
#' First, we define a common plot theme that will be used for the figures 
#' generated by this script, mostly for specifying font sizes and margins.

th.global <- theme_bw() + 
    theme(text = element_text(size=25),
          axis.title = element_text(size=rel(1)),
          axis.text = element_text(size=rel(0.6)),
          legend.title = element_text(size=rel(1)),
          legend.text = element_text(size=rel(0.7)),
          legend.key.height = unit(0.7, "lines"),
          legend.key.width = unit(0.7, "lines"),
          plot.margin = unit(c(0.4, 0.4, 0.4, 0.4), "lines")
          )

#' We found that species ecological succession was a reasonably good predictor 
#' of parameter value and of the inversion's accuracy at retrieving that 
#' parameter. Therefore, we decided to color-code the hardwood- and 
#' conifer-specific plots by successional stage to facilitate further analysis.  
#' Here, we manually define the colors for each successional stage.

succ.colors <- scale_color_manual(values = c("early" = "green3",
                                             "mid" = "blue",
                                             "late" = "red"))

#' The two figures, one each for EWT and LMA, each consist of three panels: one 
#' for just hardwoods, one for conifers, and one for both. We first define a 
#' common "base" plot with specifications common to all three plots (for EWT 
#' first).

water.base <- ggplot() + aes(x=EWT_g_cm2, y=Cw.mu) + 
    geom_point(size=3) + 
    geom_abline(linetype="dashed") + 
    xlab("Measured") +
    ylab("Inversion estimate") +
    th.global +
    theme(legend.position="right",
          legend.margin=unit(0, "lines"))

#' Then, we create the three real plots, adding to or amending the base plot as necessary.

water.all <- water.base %+% fft.f + aes(color=plant.type) +
    xlim(0,0.06) +
    guides(color = guide_legend(title="Plant type",
                                title.position="top")) +
    annotate("text", x=0, y=0.11, label="All", size=6)
water.h <- water.base %+% fft.h + aes(color=succession) +
    xlim(0,0.02) +
    guides(color=FALSE) +
    succ.colors +
    annotate("text", x=0.004, y=0.021, label="Broadleaf", size=6)
water.c <- water.base %+% fft.c + aes(color=succession) +
    xlim(0,0.06) + succ.colors +
    annotate("text", x=0.005, y=0.11, label="Conifer", size=6) +
    guides(color = guide_legend(title="Succession",
                                title.position="top")) +
    theme(axis.title.y = element_blank())

#' Finally, we align the figure using `grid.arrange` and `arrangeGrob` 
#' (required to get one wide plot in the first row and two plots in the second 
#' row) and export to a PDF.

png("manuscript/figures/water.png", height=9, width=14, units="in", res=300, pointsize=25)
grid.arrange(arrangeGrob(water.all),
             arrangeGrob(water.h, water.c, nrow=1, widths=c(1,1.4)),
             nrow=2)
dev.off()

#' We repeat all of the above steps for the LMA plot.

lma.base <- ggplot() + aes(x=LMA_gm2, y=Cm.mu.gm2) + 
        geom_point(size=3) + 
        geom_abline(linetype="dashed") + 
        xlab("Measured") +
        ylab("Inversion estimate") +
        th.global +
        theme(legend.position="right",
              legend.margin=unit(0, "lines"))
lma.all <- lma.base %+% fft.f + aes(color=plant.type) +
        xlim(0,350) +
        guides(color = guide_legend(title="Plant type",
                                    title.position="top")) +
        annotate("text", x=0, y=820, label="All", size=6)
lma.h <- lma.base %+% fft.h + aes(color=succession) +
        xlim(0,125) +
        guides(color=FALSE) +
        succ.colors +
        annotate("text", x=15, y=150, label="Broadleaf", size=6)
lma.c <- lma.base %+% fft.c + aes(color=succession) +
        xlim(0,350) +
        succ.colors +
        guides(color = guide_legend(title="Succession",
                                    title.position="top")) +
        annotate("text", x=30, y=800, label="Conifer", size=6)
        theme(axis.title.y = element_blank())

png("manuscript/figures/lma.png", height=9, width=14, units="in", res=300, pointsize=25) 
grid.arrange(arrangeGrob(lma.all),
             arrangeGrob(lma.h, lma.c, nrow=1, widths=c(1,1.4)),
             ncol=1)
dev.off()

#' # Error statistic table
#' First, we define a function that takes the inversion estimates (`mod`) and 
#' measured values (`obs`) as inputs and returns a list containing the relevant 
#' statistics.

rmse <- function(mod, obs){
  nx <- min(sum(!is.na(mod)), sum(!is.na(obs)))
  rmse <- sqrt(sum((mod - obs)^2, na.rm=TRUE) / nx)
  bias <- mean(mod - obs, na.rm=TRUE)
  sepc <- sqrt(sum((mod - obs - bias)^2, na.rm=TRUE) / nx)
  cv <- sepc / mean(mod, na.rm=TRUE)
  rmspe <- sqrt(sum((mod/obs - 1)^2, na.rm=TRUE) / nx)
  out <- list(RMSE=rmse, BIAS=bias, SEPC=sepc, CV=cv, RMSPE=rmspe)
  return(out)
}

#' Then, we use `data.table` syntax to apply the function to the `fft.f` data 
#' table by plant type. We use `rbind` to combine the two resulting tables into 
#' one and manually reorder and rename the columns. Finally, we print the table 
#' to the screen.

rmse.water <- fft.f[, rmse(Cw.mu, EWT_g_cm2), by=plant.type][,param := "EWT"]
rmse.lma <- fft.f[, rmse(Cm.mu, LMA_g_DW_cm2), by=plant.type][,param := "LMA"]
rmse.table <- rbind(rmse.water, rmse.lma)
setcolorder(rmse.table, c("param", "plant.type", "RMSE", "BIAS", "SEPC", "CV", "RMSPE"))
setnames(rmse.table, c("param", "plant.type"), c("Parameter", "Plant type"))
print("Error stats for EWT and LMA model estimates compared to inversion.")
print(rmse.table, digits=4)

